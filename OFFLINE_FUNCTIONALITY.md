# Offline Functionality Documentation

## –ü—Ä–µ–≥–ª–µ–¥

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ Luna Bar –≤–∫–ª—é—á–≤–∞ –ø—ä–ª–Ω–∞ offline —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–Ω–æ—Å—Ç –∫–æ—è—Ç–æ –¥–µ—Ç–µ–∫—Ç–∏—Ä–∞ –∫–æ–≥–∞—Ç–æ —Å—ä—Ä–≤—ä—Ä—ä—Ç –µ –Ω–µ–¥–æ—Å—Ç—ä–ø–µ–Ω –∏–ª–∏ –Ω—è–º–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—Ä—ä–∑–∫–∞ –∏ –ø–æ–∫–∞–∑–≤–∞ –º–æ–¥–∞–ª –∫–æ–π—Ç–æ –±–ª–æ–∫–∏—Ä–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –¥–æ–∫–∞—Ç–æ –≤—Ä—ä–∑–∫–∞—Ç–∞ –Ω–µ —Å–µ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–∏.

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

### 1. OfflineBanner Component (`components/OfflineBanner.tsx`)

React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–æ–π—Ç–æ –ø–æ–∫–∞–∑–≤–∞ –º–æ–¥–∞–ª –∫–æ–≥–∞—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –µ offline –∏–ª–∏ —Å—ä—Ä–≤—ä—Ä—ä—Ç –µ —Å–ø—Ä—è–Ω.

**–û—Å–Ω–æ–≤–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏:**
- –°–ª—É—à–∞ –∑–∞ —Å—ä–æ–±—â–µ–Ω–∏—è –æ—Ç Service Worker (`SERVER_OFFLINE`)
- –°–ª—É—à–∞ –∑–∞ browser online/offline events
- –ü–µ—Ä–∏–æ–¥–∏—á–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–≥–∞—Ç–æ –µ offline (`/api/health`): 5 —Å–µ–∫—É–Ω–¥–∏ –∑–∞ iOS, 10 —Å–µ–∫—É–Ω–¥–∏ –∑–∞ Android/Desktop
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞—Ç–≤–∞—Ä—è —Å–µ –∫–æ–≥–∞—Ç–æ –≤—Ä—ä–∑–∫–∞—Ç–∞ —Å–µ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–∏
- –ë–ª–æ–∫–∏—Ä–∞ –≤—Å–∏—á–∫–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ (pointer-events-none, opacity)

**–°—ä—Å—Ç–æ—è–Ω–∏—è:**
- `isOffline`: –ü–æ–∫–∞–∑–≤–∞ –¥–∞–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –µ offline
- `isChecking`: –ü–æ–∫–∞–∑–≤–∞ –∫–æ–≥–∞—Ç–æ –≤—Ä—ä–∑–∫–∞—Ç–∞ –µ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–µ–Ω–∞ (–∑–µ–ª–µ–Ω–∞ –∞–Ω–∏–º–∞—Ü–∏—è)
- `isServerDown`: –†–∞–∑–≥—Ä–∞–Ω–∏—á–∞–≤–∞ –ø—Ä–æ–±–ª–µ–º–∏ —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞ –æ—Ç –ø—Ä–æ–±–ª–µ–º–∏ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç

### 2. Service Worker (`public/sw.js`)

Service Worker –∫–æ–π—Ç–æ –æ–±—Ä–∞–±–æ—Ç–≤–∞ –∫–µ—à–∏—Ä–∞–Ω–µ—Ç–æ –∏ offline –¥–µ—Ç–µ–∫—Ü–∏—è—Ç–∞.

**–û—Å–Ω–æ–≤–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏:**

#### GET –∑–∞—è–≤–∫–∏:
- Network-first —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: –æ–ø–∏—Ç–≤–∞ —Å–µ –¥–∞ –∑–∞—Ä–µ–¥–∏ –æ—Ç network, –∞–∫–æ fail-–Ω–µ - –æ—Ç cache
- –ó–∞ `/api/*` routes: –≤–∏–Ω–∞–≥–∏ –≤—Ä—ä—â–∞ JSON error (503), –Ω–∏–∫–æ–≥–∞ HTML
- –ó–∞ navigation requests: –≤—Ä—ä—â–∞ –º–∏–Ω–∏–º–∞–ª–µ–Ω HTML —Å –º–æ–¥–∞–ª (–∑–∞–ø–∞–∑–≤–∞ URL, –Ω–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ä–∞)

#### POST/PUT/DELETE –∑–∞—è–≤–∫–∏:
- –í–∏–Ω–∞–≥–∏ –æ–ø–∏—Ç–≤–∞ network
- –ê–∫–æ fail-–Ω–µ, –∏–∑–ø—Ä–∞—â–∞ `SERVER_OFFLINE` —Å—ä–æ–±—â–µ–Ω–∏–µ –¥–æ –≤—Å–∏—á–∫–∏ clients
- –í—Ä—ä—â–∞ JSON error response (503) –∑–∞ API routes

#### Offline HTML:
- –ö–æ–≥–∞—Ç–æ –Ω—è–º–∞ –∫–µ—à –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞, –≤—Ä—ä—â–∞ –º–∏–Ω–∏–º–∞–ª–µ–Ω HTML —Å –º–æ–¥–∞–ª
- –ó–∞–¥–∞–≤–∞ `window.__isOffline = true` –∑–∞ –¥–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏ –∫—ä–º login
- –ü—Ä–æ–≤–µ—Ä—è–≤–∞ –Ω–∞ –≤—Å–µ–∫–∏ 10 —Å–µ–∫—É–Ω–¥–∏ –¥–∞–ª–∏ —Å—ä—Ä–≤—ä—Ä—ä—Ç –µ –æ–Ω–ª–∞–π–Ω
- –ü—Ä–∏ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ - —Ä–µ—Ñ—Ä–µ—à–≤–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞

### 3. ConditionalNav Component (`components/ConditionalNav.tsx`)

Wrapper –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–æ–π—Ç–æ –≤–∫–ª—é—á–≤–∞ OfflineBanner –∏ –±–ª–æ–∫–∏—Ä–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è—Ç–∞ –∫–æ–≥–∞—Ç–æ –µ offline.

**–§—É–Ω–∫—Ü–∏–∏:**
- –ü–æ–∫–∞–∑–≤–∞ OfflineBanner –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- –ë–ª–æ–∫–∏—Ä–∞ –≤—Å–∏—á–∫–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (`pointer-events-none`, `opacity-50`)
- –ï–∫—Å–ø–æ–Ω–∏—Ä–∞ `window.__isOffline` –∑–∞ –¥—Ä—É–≥–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∏ –¥–µ—Ç–µ–∫—Ü–∏—è—Ç–∞

### 1. Network Offline Detection

–ö–æ–≥–∞—Ç–æ –±—Ä–∞—É–∑—ä—Ä—ä—Ç –¥–µ—Ç–µ–∫—Ç–∏—Ä–∞ —á–µ –Ω—è–º–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç:
- Browser `offline` event —Å–µ –∑–∞–¥–µ–π—Å—Ç–≤–∞
- `OfflineBanner` –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ä—Ç —Å–µ –∞–∫—Ç–∏–≤–∏—Ä–∞
- –ü–æ–∫–∞–∑–≤–∞ —Å–µ –º–æ–¥–∞–ª —Å —Å—ä–æ–±—â–µ–Ω–∏–µ "–ù—è–º–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—Ä—ä–∑–∫–∞"

### 2. Server Down Detection

–ö–æ–≥–∞—Ç–æ —Å—ä—Ä–≤—ä—Ä—ä—Ç –µ —Å–ø—Ä—è–Ω –Ω–æ –∏–º–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç:

#### –ü—Ä–∏ POST/PUT/DELETE –∑–∞—è–≤–∫–∏:
1. Service Worker –æ–ø–∏—Ç–≤–∞ fetch –∑–∞—è–≤–∫–∞
2. –ó–∞—è–≤–∫–∞—Ç–∞ fail-–≤–∞ (network error)
3. Service Worker –∏–∑–ø—Ä–∞—â–∞ `SERVER_OFFLINE` message –¥–æ –≤—Å–∏—á–∫–∏ clients
4. `OfflineBanner` —Å–ª—É—à–∞ –∑–∞ —Ç–æ–≤–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ –∏ —Å–µ –∞–∫—Ç–∏–≤–∏—Ä–∞

#### –ü—Ä–∏ GET –∑–∞—è–≤–∫–∏:
1. Service Worker –æ–ø–∏—Ç–≤–∞ fetch –∑–∞—è–≤–∫–∞
2. –ó–∞—è–≤–∫–∞—Ç–∞ fail-–≤–∞
3. –ê–∫–æ –Ω—è–º–∞ cache - –≤—Ä—ä—â–∞ offline HTML –º–æ–¥–∞–ª
4. Offline HTML –∑–∞–¥–∞–≤–∞ `window.__isOffline = true`
5. –ü—Ä–æ–≤–µ—Ä—è–≤–∞ –Ω–∞ –≤—Å–µ–∫–∏ 10 —Å–µ–∫—É–Ω–¥–∏ –¥–∞–ª–∏ —Å—ä—Ä–≤—ä—Ä—ä—Ç –µ –æ–Ω–ª–∞–π–Ω

#### –ü—Ä–∏ –º–æ–¥–∞–ª–∏ (–¥–æ–±–∞–≤—è–Ω–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ):
1. –ú–æ–¥–∞–ª—ä—Ç –ø—Ä–∞–≤–∏ POST/PUT –∑–∞—è–≤–∫–∞
2. –ó–∞—è–≤–∫–∞—Ç–∞ fail-–≤–∞ –∏–ª–∏ –≤—Ä—ä—â–∞ 503
3. Catch block-—ä—Ç –∞–∫—Ç–∏–≤–∏—Ä–∞ offline state —á—Ä–µ–∑ `window.__setOfflineState(true)`
4. `OfflineBanner` —Å–µ –ø–æ–∫–∞–∑–≤–∞

### 3. Health Check

–ö–æ–≥–∞—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –µ offline:
- `OfflineBanner` –ø—Ä–∞–≤–∏ periodic health check –Ω–∞ –≤—Å–µ–∫–∏ 10 —Å–µ–∫—É–Ω–¥–∏
- –ü—Ä–æ–≤–µ—Ä—è–≤–∞ `/api/health` endpoint
- –ê–∫–æ endpoint-—ä—Ç –≤—ä—Ä–Ω–µ 200 OK - –≤—Ä—ä–∑–∫–∞—Ç–∞ –µ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–µ–Ω–∞
- –ú–æ–¥–∞–ª—ä—Ç –ø–æ–∫–∞–∑–≤–∞ "–í—Ä—ä–∑–∫–∞—Ç–∞ –µ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–µ–Ω–∞!" —Å –∑–µ–ª–µ–Ω–∞ –∞–Ω–∏–º–∞—Ü–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–µ –∑–∞—Ç–≤–∞—Ä—è —Å–ª–µ–¥ 1 —Å–µ–∫—É–Ω–¥–∞

## –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç—è–≤–∞–Ω–µ –Ω–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏

### –ü—Ä–æ–±–ª–µ–º:
–ö–æ–≥–∞—Ç–æ Service Worker –≤—Ä—ä—â–∞ offline HTML, React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –Ω–µ —Å–µ –∑–∞—Ä–µ–∂–¥–∞ –ø—Ä–∞–≤–∏–ª–Ω–æ. Admin/Staff —Å—Ç—Ä–∞–Ω–∏—Ü–∏—Ç–µ –∏–º–∞—Ç `useEffect` hooks –∫–æ–∏—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–≤–∞—Ç –∑–∞ session –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ä–∞—Ç –∫—ä–º login –∞–∫–æ –Ω—è–º–∞ stav–Ω–∏ session.

### –†–µ—à–µ–Ω–∏–µ:

1. **Offline HTML –∑–∞–¥–∞–≤–∞ `window.__isOffline = true`**
   ```javascript
   window.__isOffline = true;
   ```

2. **Admin/Staff —Å—Ç—Ä–∞–Ω–∏—Ü–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä—è–≤–∞—Ç –ø—Ä–µ–¥–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç:**
   ```javascript
   useEffect(() => {
     // Don't redirect if offline
     if (typeof window !== 'undefined' && (window as any).__isOffline) {
       return;
     }
     // ... redirect logic
   }, [session, locale]);
   ```

3. **–ü—Ä–∏ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ:**
   ```javascript
   window.__isOffline = false; // Before reload
   window.location.reload();
   ```

## API Endpoints

### `/api/health`
–ü—Ä–æ—Å—Ç–æ endpoint –∫–æ–π—Ç–æ –≤—Ä—ä—â–∞ 200 OK –∞–∫–æ —Å—ä—Ä–≤—ä—Ä—ä—Ç –µ –æ–Ω–ª–∞–π–Ω.

**–ò–∑–ø–æ–ª–∑–≤–∞ —Å–µ –∑–∞:**
- Periodic health checks –Ω–∞ –≤—Å–µ–∫–∏ 10 —Å–µ–∫—É–Ω–¥–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ —Å—ä—Ä–≤—ä—Ä—ä—Ç –µ –æ–Ω–ª–∞–π–Ω —Å–ª–µ–¥ network reconnect

## –ì–ª–æ–±–∞–ª–Ω–∏ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∏

### `window.__isOffline`
Boolean –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∞ –∫–æ—è—Ç–æ –ø–æ–∫–∞–∑–≤–∞ –¥–∞–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –µ offline.
- –ó–∞–¥–∞–≤–∞ —Å–µ –æ—Ç `OfflineBanner` –∏ Service Worker
- –ò–∑–ø–æ–ª–∑–≤–∞ —Å–µ –æ—Ç Admin/Staff —Å—Ç—Ä–∞–Ω–∏—Ü–∏ –∑–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç—è–≤–∞–Ω–µ –Ω–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏

### `window.__setOfflineState`
–§—É–Ω–∫—Ü–∏—è –∫–æ—è—Ç–æ –º–æ–∂–µ –¥–∞ —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞ –∑–∞ —Ä—ä—á–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω–µ –Ω–∞ offline state.
- –ò–∑–ø–æ–ª–∑–≤–∞ —Å–µ –æ—Ç –º–æ–¥–∞–ª–∏ –∫–æ–≥–∞—Ç–æ POST/PUT –∑–∞—è–≤–∫–∏ fail-–≤–∞—Ç

### `window.__setServerDown`
–§—É–Ω–∫—Ü–∏—è –∫–æ—è—Ç–æ –∑–∞–¥–∞–≤–∞ –¥–∞–ª–∏ –ø—Ä–æ–±–ª–µ–º—ä—Ç –µ —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞ –∏–ª–∏ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.
- –ò–∑–ø–æ–ª–∑–≤–∞ —Å–µ –∑–∞ –ø–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –ø—Ä–∞–≤–∏–ª–Ω–æ—Ç–æ —Å—ä–æ–±—â–µ–Ω–∏–µ

## –§–∞–π–ª–æ–≤–µ –∫–æ–∏—Ç–æ –æ–±—Ä–∞–±–æ—Ç–≤–∞—Ç offline state

### –ú–æ–¥–∞–ª–∏ –∏ —Ñ–æ—Ä–º–∏:
- `app/[locale]/admin/products/new/page.tsx` - –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç
- `app/[locale]/admin/products/[id]/edit/page.tsx` - –†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç
- `app/[locale]/admin/categories/page.tsx` - –î–æ–±–∞–≤—è–Ω–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ/–∏–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∏:**
```javascript
try {
  const response = await fetch('/api/products', { ... });
  
  if (response.status === 503 || !response.ok) {
    // Trigger offline banner
    if (typeof window !== 'undefined' && (window as any).__setOfflineState) {
      (window as any).__setOfflineState(true);
    }
    if (typeof window !== 'undefined' && (window as any).__setServerDown) {
      (window as any).__setServerDown(true);
    }
    throw new Error('Server is offline');
  }
} catch (error) {
  // Handle network errors
}
```

## –°—ä–æ–±—â–µ–Ω–∏—è

### Offline –º–æ–¥–∞–ª —Å—ä–æ–±—â–µ–Ω–∏—è:

1. **–ù—è–º–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—Ä—ä–∑–∫–∞:**
   - –ó–∞–≥–ª–∞–≤–∏–µ: "–ù—è–º–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—Ä—ä–∑–∫–∞"
   - –¢–µ–∫—Å—Ç: "–ú–æ–ª—è, –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—Ä—ä–∑–∫–∞—Ç–∞ —Å–∏ –∏ –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."

2. **–°—ä—Ä–≤—ä—Ä—ä—Ç –µ –Ω–µ–¥–æ—Å—Ç—ä–ø–µ–Ω:**
   - –ó–∞–≥–ª–∞–≤–∏–µ: "–í—Ä–µ–º–µ–Ω–µ–Ω –ø—Ä–æ–±–ª–µ–º —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞"
   - –¢–µ–∫—Å—Ç: "–°—ä—Ä–≤—ä—Ä—ä—Ç –µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—ä–ø–µ–Ω. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞ –≤—Å–µ–∫–∏ 10 —Å–µ–∫—É–Ω–¥–∏ –¥–∞–ª–∏ —Å—ä—Ä–≤—ä—Ä—ä—Ç –µ –æ—Ç–Ω–æ–≤–æ –æ–Ω–ª–∞–π–Ω."

3. **–í—Ä—ä–∑–∫–∞—Ç–∞ –µ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–µ–Ω–∞:**
   - –ó–∞–≥–ª–∞–≤–∏–µ: "–í—Ä—ä–∑–∫–∞—Ç–∞ –µ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–µ–Ω–∞!"
   - –¢–µ–∫—Å—Ç: "–í–µ—á–µ –∏–º–∞—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—Ä—ä–∑–∫–∞. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –µ –≥–æ—Ç–æ–≤–æ –∑–∞ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ."
   - –ó–µ–ª–µ–Ω–∞ –∞–Ω–∏–º–∞—Ü–∏—è —Å spin –∏–∫–æ–Ω–∫–∞

## iOS –∏ –ú–æ–±–∏–ª–Ω–∏ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

### iOS Safari –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∏ –ü–æ–ø—Ä–∞–≤–∫–∏

iOS Safari –∏–º–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ –ø–æ–¥–¥—Ä—ä–∂–∫–∞ –∑–∞ Service Workers –∏ –Ω–µ–Ω–∞–¥–µ–∂–¥–Ω–∏ browser events. –ó–∞—Ç–æ–≤–∞ —Å–∞ –¥–æ–±–∞–≤–µ–Ω–∏ —Å–ø–µ—Ü–∏–∞–ª–Ω–∏ –º–µ—Ö–∞–Ω–∏–∑–º–∏:

#### 1. –ü–æ-–ß–µ—Å—Ç–∞ Health Check
- **iOS**: –ü—Ä–æ–≤–µ—Ä—è–≤–∞ –Ω–∞ –≤—Å–µ–∫–∏ **5 —Å–µ–∫—É–Ω–¥–∏** –≤–º–µ—Å—Ç–æ 10
- **Android/Desktop**: –ü—Ä–æ–≤–µ—Ä—è–≤–∞ –Ω–∞ –≤—Å–µ–∫–∏ **10 —Å–µ–∫—É–Ω–¥–∏**
- –ü—Ä–∏—á–∏–Ω–∞: iOS browser events (`online`/`offline`) –Ω–µ —Ä–∞–±–æ—Ç—è—Ç –Ω–∞–¥–µ–∂–¥–Ω–æ

#### 2. Fetch Error Interceptor –∑–∞ iOS
- –ê–∫–æ Service Worker –Ω–µ —Ä–∞–±–æ—Ç–∏ –Ω–∞ iOS, –¥–æ–±–∞–≤–µ–Ω –µ fallback –º–µ—Ö–∞–Ω–∏–∑—ä–º
- –ü—Ä–∏—Ö–≤–∞—â–∞ –≤—Å–∏—á–∫–∏ `fetch` errors –∏ –ø—Ä–æ–≤–µ—Ä—è–≤–∞ –¥–∞–ª–∏ —Å—ä—Ä–≤—ä—Ä—ä—Ç –µ online
- –ê–∫–æ `fetch` fail-–Ω–µ —Å network error ‚Üí –ø—Ä–∞–≤–∏ health check ‚Üí –∞–∫—Ç–∏–≤–∏—Ä–∞ offline state

#### 3. –ö–∞–∫ –†–∞–±–æ—Ç–∏ –Ω–∞ iOS:

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: Service Worker –†–∞–±–æ—Ç–∏ (HTTPS/Production)**
1. Service Worker –∏–∑–ø—Ä–∞—â–∞ `SERVER_OFFLINE` message
2. `OfflineBanner` —Å–ª—É—à–∞ –∑–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ –∏ —Å–µ –∞–∫—Ç–∏–≤–∏—Ä–∞
3. –ü–µ—Ä–∏–æ–¥–∏—á–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—Å–µ–∫–∏ 5 —Å–µ–∫—É–Ω–¥–∏
4. –ü—Ä–∏ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–µ –∑–∞—Ç–≤–∞—Ä—è

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: Service Worker –ù–µ –†–∞–±–æ—Ç–∏ (HTTP/Localhost)**
1. `fetch` –∑–∞—è–≤–∫–∞ fail-–≤–∞ (network error)
2. Fetch interceptor –ø—Ä–∏—Ö–≤–∞—â–∞ –≥—Ä–µ—à–∫–∞—Ç–∞
3. –ü—Ä–∞–≤–∏ health check –∑–∞ –ø–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ
4. –ê–∫–æ —Å—ä—Ä–≤—ä—Ä—ä—Ç –µ down ‚Üí –∞–∫—Ç–∏–≤–∏—Ä–∞ offline state
5. –ü–µ—Ä–∏–æ–¥–∏—á–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—Å–µ–∫–∏ 5 —Å–µ–∫—É–Ω–¥–∏

### –í–∞–∂–Ω–∏ –ë–µ–ª–µ–∂–∫–∏ –∑–∞ iOS:

1. **HTTPS –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–µ–Ω –∑–∞ production**
   - Service Worker —Ä–∞–±–æ—Ç–∏ —Å–∞–º–æ —Å HTTPS –Ω–∞ iOS
   - –ù–∞ `localhost` (127.0.0.1) –º–æ–∂–µ –¥–∞ —Ä–∞–±–æ—Ç–∏
   - **–ù–∞ HTTP –ø—Ä–µ–∑ –ª–æ–∫–∞–ª–Ω–æ IP (–Ω–∞–ø—Ä. 192.168.x.x) –ù–ï –†–ê–ë–û–¢–ò!**

2. **Browser Events —Å–∞ –Ω–µ–Ω–∞–¥–µ–∂–¥–Ω–∏**
   - `navigator.onLine` –Ω–µ –µ –Ω–∞–¥–µ–∂–¥–µ–Ω –Ω–∞ iOS
   - `online`/`offline` events –º–æ–∂–µ –¥–∞ –Ω–µ —Å–µ –∑–∞–¥–µ–π—Å—Ç–≤–∞—Ç
   - –ó–∞—Ç–æ–≤–∞ –∏–∑–ø–æ–ª–∑–≤–∞–º–µ –∞–∫—Ç–∏–≤–Ω–∞ health check –≤–º–µ—Å—Ç–æ –ø–∞—Å–∏–≤–Ω–∏ events

3. **–ü–æ-–ß–µ—Å—Ç–∞ –ü—Ä–æ–≤–µ—Ä–∫–∞**
   - iOS –ø—Ä–æ–≤–µ—Ä—è–≤–∞ –Ω–∞ –≤—Å–µ–∫–∏ 5 —Å–µ–∫—É–Ω–¥–∏ –∑–∞ –ø–æ-–±—ä—Ä–∑–æ –¥–µ—Ç–µ–∫—Ç–∏—Ä–∞–Ω–µ
   - –¢–æ–≤–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–∞ —á–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –≤–∏–∂–¥–∞ –∫–æ–≥–∞—Ç–æ —Å—ä—Ä–≤—ä—Ä—ä—Ç —Å–µ –≤—ä—Ä–Ω–µ

4. **–†–∞–∑–≥—Ä–∞–Ω–∏—á–∞–≤–∞–Ω–µ –º–µ–∂–¥—É Network Offline –∏ Server Down**
   - –ö–æ–≥–∞—Ç–æ Service Worker –∏–∑–ø—Ä–∞—Ç–∏ `SERVER_OFFLINE`, –ø—Ä–æ–≤–µ—Ä—è–≤–∞–º–µ `navigator.onLine`
   - –ê–∫–æ `navigator.onLine = false` ‚Üí Network offline (–ø–æ–∫–∞–∑–≤–∞ "–ù—è–º–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—Ä—ä–∑–∫–∞")
   - –ê–∫–æ `navigator.onLine = true` ‚Üí Server down (–ø–æ–∫–∞–∑–≤–∞ "–í—Ä–µ–º–µ–Ω–µ–Ω –ø—Ä–æ–±–ª–µ–º —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞")

## –¢–µ—Å—Ç–≤–∞–Ω–µ

### –¢–µ—Å—Ç 1: Network Offline
1. –û—Ç–≤–æ—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ
2. –í DevTools ‚Üí Network ‚Üí Set to "Offline"
3. –û—á–∞–∫–≤–∞–Ω —Ä–µ–∑—É–ª—Ç–∞—Ç: Offline –º–æ–¥–∞–ª —Å–µ –ø–æ–∫–∞–∑–≤–∞ –≤–µ–¥–Ω–∞–≥–∞

### –¢–µ—Å—Ç 2: Server Ant Down
1. –°—Ç–∞—Ä—Ç–∏—Ä–∞–π dev —Å—ä—Ä–≤—ä—Ä
2. –û—Ç–≤–æ—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ
3. –°–ø—Ä–∏ —Å—ä—Ä–≤—ä—Ä–∞ (Ctrl+C)
4. –û—á–∞–∫–≤–∞–Ω —Ä–µ–∑—É–ª—Ç–∞—Ç: Offline –º–æ–¥–∞–ª —Å–µ –ø–æ–∫–∞–∑–≤–∞ –ø—Ä–∏ —Å–ª–µ–¥–≤–∞—â–∞ –∑–∞—è–≤–∫–∞

### –¢–µ—Å—Ç 3: Offline Modal –ø—Ä–∏ –º–æ–¥–∞–ª
1. –û—Ç–≤–æ—Ä–∏ Admin –ø–∞–Ω–µ–ª
2. –û—Ç–≤–æ—Ä–∏ "–î–æ–±–∞–≤–∏ –ø—Ä–æ–¥—É–∫—Ç" –º–æ–¥–∞–ª
3. –°–ø—Ä–∏ —Å—ä—Ä–≤—ä—Ä–∞
4. –û–ø–∏—Ç–∞–π –¥–∞ –∑–∞–ø–∞–∑–∏—à –ø—Ä–æ–¥—É–∫—Ç–∞
5. –û—á–∞–∫–≤–∞–Ω —Ä–µ–∑—É–ª—Ç–∞—Ç: Offline –º–æ–¥–∞–ª —Å–µ –ø–æ–∫–∞–∑–≤–∞

### –¢–µ—Å—Ç 4: Health Check
1. –°–ø—Ä–∏ —Å—ä—Ä–≤—ä—Ä–∞
2. –û—á–∞–∫–≤–∞–π 10 —Å–µ–∫—É–Ω–¥–∏
3. –°—Ç–∞—Ä—Ç–∏—Ä–∞–π —Å—ä—Ä–≤—ä—Ä–∞ –æ—Ç–Ω–æ–≤–æ
4. –û—á–∞–∫–≤–∞–Ω —Ä–µ–∑—É–ª—Ç–∞—Ç: –ú–æ–¥–∞–ª—ä—Ç –ø–æ–∫–∞–∑–≤–∞ "–í—Ä—ä–∑–∫–∞—Ç–∞ –µ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–µ–Ω–∞!" –∏ —Å–µ –∑–∞—Ç–≤–∞—Ä—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ

### –¢–µ—Å—Ç 5: Redirect Prevention
1. –û—Ç–≤–æ—Ä–∏ Admin/Staff –ø–∞–Ω–µ–ª (—Å–ª–µ–¥ login)
2. –°–ø—Ä–∏ —Å—ä—Ä–≤—ä—Ä–∞
3. –†–µ—Ñ—Ä–µ—à–Ω–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞
4. –û—á–∞–∫–≤–∞–Ω —Ä–µ–∑—É–ª—Ç–∞—Ç: –ü–æ–∫–∞–∑–≤–∞ —Å–µ offline –º–æ–¥–∞–ª, –ù–ï —Å–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ä–∞ –∫—ä–º login

### –¢–µ—Å—Ç 6: iOS Offline Detection
1. –û—Ç–≤–æ—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –Ω–∞ iOS —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
2. –°–ø—Ä–∏ —Å—ä—Ä–≤—ä—Ä–∞
3. –û–ø–∏—Ç–∞–π –¥–∞ –∑–∞—Ä–µ–¥–∏—à —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–ª–∏ –¥–∞ –∑–∞–ø–∞–∑–∏—à —Ñ–æ—Ä–º–∞
4. –û—á–∞–∫–≤–∞–Ω —Ä–µ–∑—É–ª—Ç–∞—Ç: 
   - Offline –º–æ–¥–∞–ª —Å–µ –ø–æ–∫–∞–∑–≤–∞ (–∏–ª–∏ —á—Ä–µ–∑ Service Worker –∏–ª–∏ —á—Ä–µ–∑ fetch interceptor)
   - Health check –Ω–∞ –≤—Å–µ–∫–∏ 5 —Å–µ–∫—É–Ω–¥–∏ (–Ω–µ 10)
   - –ü—Ä–∏ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ - –º–æ–¥–∞–ª—ä—Ç —Å–µ –∑–∞—Ç–≤–∞—Ä—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ

**–ó–∞–±–µ–ª–µ–∂–∫–∞ –∑–∞ iOS:**
- –ù–∞ production (HTTPS) - Service Worker —Ä–∞–±–æ—Ç–∏ –ø–µ—Ä—Ñ–µ–∫—Ç–Ω–æ
- –ù–∞ localhost/HTTP - –º–æ–∂–µ –¥–∞ —Ä–∞–±–æ—Ç–∏ —á–∞—Å—Ç–∏—á–Ω–æ, –Ω–æ fetch interceptor –≥–∞—Ä–∞–Ω—Ç–∏—Ä–∞ –¥–µ—Ç–µ–∫—Ü–∏—è—Ç–∞

## Service Worker –í–µ—Ä—Å–∏—è Display

–í –¥–æ–ª–Ω–∏—è –¥–µ—Å–µ–Ω —ä–≥—ä–ª –Ω–∞ –≤—Å—è–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–º–∞ –±—É—Ç–æ–Ω "SW" –∫–æ–π—Ç–æ –ø–æ–∫–∞–∑–≤–∞ —Ç–µ–∫—É—â–∞—Ç–∞ –≤–µ—Ä—Å–∏—è –Ω–∞ Service Worker.

**–ö–∞–∫ –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞—à:**
1. –ù–∞—Ç–∏—Å–Ω–∏ –±—É—Ç–æ–Ω–∞ "SW" –≤ –¥–æ–ª–Ω–∏—è –¥–µ—Å–µ–Ω —ä–≥—ä–ª
2. –ü–æ–∫–∞–∑–≤–∞ —Å–µ –ø–∞–Ω–µ–ª —Å —Ç–µ–∫—É—â–∞ –≤–µ—Ä—Å–∏—è (–Ω–∞–ø—Ä. "v3.3.1")
3. –ù–∞—Ç–∏—Å–Ω–∏ –æ—Ç–Ω–æ–≤–æ –∑–∞ –¥–∞ —Å–∫—Ä–∏–µ—à –ø–∞–Ω–µ–ª–∞

**–°—Ç–∞—Ç—É—Å–∏:**
- üü¢ **–ó–µ–ª–µ–Ω–∞ —Ç–æ—á–∫–∞** + "Service Worker" = SW —Ä–∞–±–æ—Ç–∏ –ø–µ—Ä—Ñ–µ–∫—Ç–Ω–æ
- üü† **–û—Ä–∞–Ω–∂–µ–≤–∞ —Ç–æ—á–∫–∞** + "SW Limited" = SW –Ω–µ —Ä–∞–±–æ—Ç–∏ (iOS HTTP), –∏–∑–ø–æ–ª–∑–≤–∞ fallback

**–ó–∞—â–æ –µ –ø–æ–ª–µ–∑–Ω–æ:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –Ω–æ–≤–∞—Ç–∞ –≤–µ—Ä—Å–∏—è –µ –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω–∞ —Å–ª–µ–¥ deploy
- –î–µ–±—ä–≥–≤–∞–Ω–µ –Ω–∞ –º–æ–±–∏–ª–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–æ—Å–æ–±–µ–Ω–æ iOS)
- –ü–æ—Ç–≤—ä—Ä–∂–¥–∞–≤–∞–Ω–µ —á–µ Service Worker —Ä–∞–±–æ—Ç–∏
- –í–∏–∂–¥–∞–Ω–µ –¥–∞–ª–∏ iOS HTTP –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ—Ç–æ —Å–µ –∑–∞–¥–µ–π—Å—Ç–≤–∞

**iOS HTTP –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:**
- –ù–∞ iOS –ø—Ä–µ–∑ –ª–æ–∫–∞–ª–Ω–æ IP (–Ω–∞–ø—Ä. `http://192.168.1.x:3000`) Service Worker –ù–ï –†–ê–ë–û–¢–ò
- –ü–æ–∫–∞–∑–≤–∞: –≤–µ—Ä—Å–∏—è `v3.3.1` (hardcoded) + warning "iOS HTTP: SW –Ω–µ —Ä–∞–±–æ—Ç–∏"
- Offline detection —Ä–∞–±–æ—Ç–∏ —á—Ä–µ–∑ fetch interceptor –≤–º–µ—Å—Ç–æ Service Worker
- **–†–µ—à–µ–Ω–∏–µ**: Deploy –Ω–∞ production —Å HTTPS –∏–ª–∏ —Ç–µ—Å—Ç–≤–∞–π –Ω–∞ Android

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏:**
- `components/ServiceWorkerVersion.tsx` - UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- `public/sw.js` - –°—ä–¥—ä—Ä–∂–∞ `CACHE_VERSION` –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –∏ –æ—Ç–≥–æ–≤–∞—Ä—è –Ω–∞ `GET_VERSION` —Å—ä–æ–±—â–µ–Ω–∏—è
- `FALLBACK_VERSION` - Hardcoded –≤–µ—Ä—Å–∏—è –∑–∞ iOS HTTP fallback

## –í–∞–∂–Ω–∏ –±–µ–ª–µ–∂–∫–∏

1. **Service Worker –≤–µ—Ä—Å–∏—è**: –ö–æ–≥–∞—Ç–æ –ø—Ä–æ–º–µ–Ω—è—à Service Worker –ª–æ–≥–∏–∫–∞—Ç–∞, —É–≤–µ–ª–∏—á–∏ `CACHE_VERSION` –≤ `public/sw.js`. –¢–µ–∫—É—â–∞—Ç–∞ –≤–µ—Ä—Å–∏—è —Å–µ –ø–æ–∫–∞–∑–≤–∞ –≤ –¥–æ–ª–Ω–∏—è –¥–µ—Å–µ–Ω —ä–≥—ä–ª (–±—É—Ç–æ–Ω "SW").
2. **Offline HTML**: –í—Ä—ä—â–∞ —Å–µ —Å–∞–º–æ –∫–æ–≥–∞—Ç–æ –Ω—è–º–∞ –∫–µ—à –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞. –ê–∫–æ –∏–º–∞ –∫–µ—à, React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ —Å–µ –∑–∞—Ä–µ–∂–¥–∞ –Ω–æ—Ä–º–∞–ª–Ω–æ.
3. **API Routes**: –í–∏–Ω–∞–≥–∏ –≤—Ä—ä—â–∞—Ç JSON error (503), –Ω–∏–∫–æ–≥–∞ HTML. –¢–æ–≤–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç—è–≤–∞ JSON parse errors.
4. **Health Check Interval**: –ü—Ä–æ–≤–µ—Ä—è–≤–∞ –Ω–∞ –≤—Å–µ–∫–∏ 5 —Å–µ–∫—É–Ω–¥–∏ –∑–∞ iOS, 10 —Å–µ–∫—É–Ω–¥–∏ –∑–∞ Android/Desktop –∫–æ–≥–∞—Ç–æ –µ offline. –¢–æ–≤–∞ –º–æ–∂–µ –¥–∞ —Å–µ –ø—Ä–æ–º–µ–Ω–∏ –≤ `OfflineBanner.tsx`.

